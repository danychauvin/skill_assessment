---
title: "data_analysis"
output: html_document
date: "2024-03-12"
---

# What can be said about the quality of the data?

To assess this, I propose to perform some sanity checks. First, we'd like to look at the distributions of all individual channels, and compare these between replicate. This will enable us to get a sense of what the phenotypes of these cells look like, in terms of central tendencies, and variability. Also, that will enable us to control for reproducibility.

### 1D Distributions

First, let's write a function that plots all desired distributions.
```{r,warning=FALSE}
plot_all_1D_distributions <- function(ini,end,condition){
  cyto_plot_save(sprintf("./figures/1d_distributions_%s.pdf",condition),width=25,height=25)
  cyto_plot_custom(layout=c(6,5))
  for (i in 1:9){
    cyto_plot(fs[ini:end],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList
              )}
  for (i in 10:30){
    cyto_plot(fs[ini:end],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList,
              xlim=c(-1e4,1e6))}
  cyto_plot_complete()}
```

Then we plot all 1D Distributions for all "postSpn","preSpn" and "saline" replicates.
```{r}
plot_all_1D_distributions(1,6,"postSpn")
plot_all_1D_distributions(7,12,"preSpn")
plot_all_1D_distributions(13,18,"saline")
```

Overall, postSpn samples are more reproducible than preSpn and saline. That also can be explained by the actual number of cells there are in each sample. There are 10 times more cells in postSpn versus preSpn, and 20 times more cells in postSpn versus saline.

```{r}
cyto_stats_compute(fs,stat="count")
```

Let's compare these distributions in each channel: pre|saline|post, to determine where distributions have changed.

```{r}


```











```{r,warning=FALSE}
plot_all_1D_distributions <- function(ini,end,condition){
  cyto_plot_save(sprintf("./figures/1d_distributions_%s.pdf",condition),width=25,height=25)
  cyto_plot_custom(layout=c(6,5))
  for (i in 1:9){
    cyto_plot(fs[ini:end],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList
              )}
  for (i in 10:30){
    cyto_plot(fs[ini:end],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList,
              xlim=c(-1e4,1e6))}
  cyto_plot_complete()}
```

We can do the same for all "preSpn" samples.

```{r,warning=FALSE}
cyto_plot_save("./figures/1d_distributions_preSpn.pdf",width=25,height=25)
cyto_plot_custom(layout=c(6,5))
for (i in 1:9){
  cyto_plot(fs[1:6],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList
            )}
for (i in 10:30){
  cyto_plot(fs[1:6],channels=cyto_channels(fs)[i],density_stack=0.7,axes_trans=transList,
            xlim=c(-1e4,1e6))}
cyto_plot_complete()
```





## Scattering distributions
Let's focus on the scatter data first.
We first prepare the data to be able to use facet_wrap.
```{r}
measurement <- c('FSC.A','FSC.H','FSC.W','SSC.A','SSC.H','SSC.W')
variable <- c('replica','replica_old',"condition")
toplot <- mydata %>% select(all_of(c(measurement,variable)))
toplot <- pivot_longer(toplot,cols = measurement,names_to = 'scattering',values_to = 'values')
```

```{r}
toplot %>% ggplot()+
  geom_freqpoly(aes(values,after_stat(density),col=replica),bins=100)+
  facet_wrap(condition~scattering,scales="free")+
  theme_cowplot()+
  expand_limits(x = 0, y = 0)
```

```{r}
measurement <- c('FSC.A','FSC.H','FSC.W','SSC.A','SSC.H','SSC.W')
variable <- c('replica','replica_old',"condition")
toplot <- mydata %>% select(all_of(c(measurement,variable)))
#toplot <- pivot_longer(toplot,cols = measurement,names_to = 'scattering',values_to = 'values')
```

```{r}
toplot %>% ggplot()+
  geom_point(aes(FSC.A,SSC.A),alpha=0.1) + 
  facet_wrap(condition~replica,scales="free")+
  theme_cowplot()+
  expand_limits(x = 0, y = 0)

```

```{r}
toplot %>% ggplot()+
  geom_point(aes(FSC.A,FSC.H),alpha=0.1) + 
  facet_wrap(condition~replica,scales="free")+
  theme_cowplot()+
  expand_limits(x = 0, y = 0)
```


```{r}
toplot %>%
  filter(condition=="postSpn") %>% 
  ggplot()+
  stat_bin_2d(aes(FSC.A,FSC.H),bins=500) + 
  #facet_wrap(condition~replica,scales="free")+
  theme_cowplot()+
  expand_limits(x = c(0,5e6), y = c(0,4e6))
```

```{r}
mydata %>%
  filter(condition=="postSpn",replica_old==84) %>% 
  ggplot()+
  stat_bin_2d(aes(CD45.2.BUV737,CD45.AF532),bins=50) + 
  #facet_wrap(condition~replica,scales="free")+
  theme_cowplot()
  #expand_limits(x = c(0,5e6), y = c(0,4e6))
```

```{r}
mydata %>%
  filter(condition=="postSpn") %>% 
  ggplot()+
  stat_bin_2d(aes(CD45.2.BUV737,SevenAAD),bins=500) + 
  #facet_wrap(condition~replica,scales="free")+
  theme_cowplot()
  #expand_limits(x = c(0,5e6), y = c(0,4e6))
```

# Generate NxN plots of all 2D heatmaps

We want to plot all variables against each other using heat map fashion.
One PDF for each replica experiment. It will enable us to judge precisely which population was actually taken in the data, and which one was discarded.

Plus, we'll check potentially bad unmixing/weird populations.

To do that quick, the best is certainly to use ggplot. But there must be a way to do that quickly taking advantage of relevant Bioconductor packages.



```{r}




```

